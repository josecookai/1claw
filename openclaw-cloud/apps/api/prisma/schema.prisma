generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  subscriptions       Subscription[]
  usageLedgers        UsageLedger[]
  instances           Instance[]
  telegramBinding     TelegramBinding?
  skillSelections     UserSkillSelection[]
  stripeCustomer      StripeCustomer?
  creditLedgers       CreditLedger[]
  topupPurchases      TopupPurchase[]
}

model Subscription {
  id                    String    @id @default(cuid())
  plan                  String
  status                String    // ACTIVE, CANCELLED, EXPIRED, PAST_DUE
  policy                String?   // BEST, CHEAP, CN_OK
  renewAt               DateTime
  currentPeriodEnd      DateTime?
  provider              String?
  stripeSubscriptionId  String?   @unique
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StripeCustomer {
  id           String   @id @default(cuid())
  userId       String   @unique
  customerId   String   @unique
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum CreditLedgerReason {
  SUB_GRANT
  TOPUP
  CHAT_DEBIT
  ADJUST
}

model CreditLedger {
  id           String             @id @default(cuid())
  userId       String
  deltaCredits Int
  reason       CreditLedgerReason
  refId        String?            // invoiceId, paymentIntentId, requestId
  note         String?
  createdAt    DateTime           @default(now())
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([refId])
}

model TopupPurchase {
  id                String   @id @default(cuid())
  userId            String
  paymentIntentId   String   @unique
  pack              String
  credits           Int
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ProcessedWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  type        String
  processedAt DateTime @default(now())

  @@index([eventId])
}

// 幂等 & 防重复发放
model ProcessedEvent {
  id          String   @id @default(cuid())
  provider    String   // "stripe"
  eventId     String
  type        String
  processedAt DateTime @default(now())

  @@unique([provider, eventId])
  @@index([provider, eventId])
}

model UsageLedger {
  id       String   @id @default(cuid())
  userId   String
  day      DateTime @db.Date
  tokens   Int      @default(0)
  cost     Float    @default(0)
  provider String?
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, day])
}

model Instance {
  id        String   @id @default(cuid())
  userId    String
  status    String   // PROVISIONING, RUNNING, STOPPED, ERROR
  region    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TelegramBinding {
  id        String    @id @default(cuid())
  userId    String    @unique
  chatId    String?   @unique // set when user does /bind in Telegram
  bindCode  String   @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([bindCode])
  @@index([chatId])
}

model Lead {
  id        String   @id @default(cuid())
  email     String
  name      String?
  plan      String
  models    String   // JSON array
  channels  String   // JSON array
  lang      String
  intent    String   // waitlist, sales
  source    String?  @default("landing_v1")
  createdAt DateTime @default(now())

  @@index([email])
  @@index([intent])
}

// OpenClaw Skill 库：Top 100+ 可扩展
model Skill {
  id            String   @id @default(cuid())
  slug          String   @unique
  nameZh        String
  nameEn        String
  descriptionZh String?
  descriptionEn String?
  category      String   // memory, productivity, research, writing, dev, etc.
  isPreinstalled Boolean @default(false)  // 是否预装（按套餐）
  sortOrder     Int      @default(0)
  source        String?  // e.g. "openclaw", "github:org/repo"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userSelections UserSkillSelection[]

  @@index([category])
  @@index([isPreinstalled])
}

// 用户选中的技能
model UserSkillSelection {
  id        String   @id @default(cuid())
  userId    String
  skillId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
}
